if: tag IS blank
language: node_js
node_js:
- node
matrix:
  include:
  - sudo: required
    os: osx
    osx_image: xcode9.4
    addons:
      chrome: stable
    before_script:
    - export DISPLAY=:99.0
    - npm install -g cordova
    - npm install -g ionic
    - "./build-assets/ios/add-key.sh"
    script:
    - npm test
    - ionic cordova build ios --prod --release --device
    after_script:
    - "./build-assets/ios/remove-key.sh"
    before_deploy:
    - zip -r ios-build.zip platforms/ios/build
    - git config --local user.name Marcell Pék
    - git config --local user.email 2333134p@student.gla.ac.uk
    - git tag "$(date +'%Y%m%d%H%M%S')-$(git log --format=%h -1)"
    after_deploy:
    - /Applications/Xcode.app/Contents/Applications/Application\ Loader.app/Contents/Frameworks/ITunesSoftwareService.framework/Support/altool
      --upload-app -f "/Users/travis/build/marcellp/attendance/platforms/ios/build/device/AttendanceLTC.ipa"
      -u $APPSTORECONNECT_USER -p @env:APPSTORECONNECT_PASSWORD
    env:
    - PROFILE_NAME="AttendanceLTC_CI_Build_Distribution_Profile"
  - sudo: required
    dist: trusty
    addons:
      chrome: stable
    licenses:
    - android-sdk-preview-license-.+
    - android-sdk-license-.+
    - google-gdk-license-.+
    before_script:
    - sudo chown root /opt/google/chrome/chrome-sandbox
    - sudo chmod 4755 /opt/google/chrome/chrome-sandbox
    - export DISPLAY=:99.0
    - sh -e /etc/init.d/xvfb start
    - sleep 3
    - npm install -g cordova
    - npm install -g ionic
    - sudo apt-get install -qq libstdc++6:i386 lib32z1 expect
    - curl -Ls https://raw.github.com/embarkmobile/android-sdk-installer/version-2/android-sdk-installer | bash /dev/stdin --install=build-tools-25.0.1,android-26,sysimg-17,extra-android-m2repository,extra-google-m2repository --accept=android-sdk-license-2742d1c5
    - source ~/.android-sdk-installer/env
    - jq --arg ANDROID_KEYSTORE_PASS "$ANDROID_KEYSTORE_PASS" '.android.release.storePassword
      = $ANDROID_KEYSTORE_PASS | .android.release.password = $ANDROID_KEYSTORE_PASS'
      build.json > build.json.tmp
    - mv build.json.tmp build.json
    - openssl aes-256-cbc -K $encrypted_896bfd344a78_key -iv $encrypted_896bfd344a78_iv
      -in signing/ios/AppleWWDRCA.cer.enc -out signing/ios/AppleWWDRCA.cer -d
    - openssl aes-256-cbc -K $encrypted_896bfd344a78_key -iv $encrypted_896bfd344a78_iv
      -in signing/ios/AttendanceLTC_CI_Build_Distribution_Profile.mobileprovision.enc
      -out signing/ios/AttendanceLTC_CI_Build_Distribution_Profile.mobileprovision
      -d
    - openssl aes-256-cbc -K $encrypted_896bfd344a78_key -iv $encrypted_896bfd344a78_iv
      -in signing/ios/dist.cer.enc -out signing/ios/dist.cer -d
    - openssl aes-256-cbc -K $encrypted_896bfd344a78_key -iv $encrypted_896bfd344a78_iv
      -in signing/ios/dist.p12.enc -out signing/ios/dist.p12 -d
    - openssl aes-256-cbc -K $encrypted_896bfd344a78_key -iv $encrypted_896bfd344a78_iv
      -in signing/android/release-key.jks.enc -out signing/android/release-key.jks
      -d
    script:
    - npm test
    - ionic cordova plugin add cordova-android-support-gradle-release  --variable
      ANDROID_SUPPORT_VERSION=26.+
    - ionic cordova build android --prod --release
    - cd AttendanceService
    - mvn install
    before_deploy:
    - git config --local user.name Marcell Pék
    - git config --local user.email 2333134p@student.gla.ac.uk
    - git tag "$(date +'%Y%m%d%H%M%S')-$(git log --format=%h -1)"
deploy:
  -
    provider: releases
    api_key:
      secure: aaaJbBPWJBpJRhuPRCjGR1/nFNNJX325d74QxOcQvVLps5c7SjefRzAmk5yJZA1RVaaIL1ZK5hfr34UauHaxKp9tQ2oiZC6W5ORGvDlH6khd3Nj4zptRn0j/LKgjGOdZLpyR3FY2o/BgadfsTbrbeAVeDYmh639/j+l7uDRWeXseiQ/PnyHtBP9VaPsZdz4lO9t4vJjbBYxzAQiopqZwf3wRkUL6xRaJqFPCWVu8SKLfINpmtRH/Qco9Xe1IzewyNMBtAWSlEE8SbKGHb6vJmebepgRYbMMLpsws6fbfNxuBWmRlyPTxgwCFbsUC8lHmRbXz2qjY+aY1qlWnD2uWc8adMt0Ok81Qq+AQuGY/4JxX54UX+VYhyKrCbSjrzKQVMMoP3pDlhv3xzXbxYUbV1JQCZ+5mVhsmeAGY5/Dkb9vxODi33iXBJG+oz1sfWAm97gB/PvWitH/A0XbP3kUwgZ0Rypl5qBZx/ti6CK8NIGIrxA5sfpY/PdLxRsFfuq33yH/NWsGuEa36SLMOd8DcwjssT+Dw5AnTeCOjOuxiPTTLUuIlBY4juG7VmKw5HHLg7f6e3Xlm2SET3lTZIUyp3JHtXbG5a8cEWtXVwU7y+LGYxeMea75Bj4BjiYRf+xCecrnZ7z4L/+VCWVDTh+SfFGn7HCN53Cn+bkANAGgIu5mK/s=
    file:
      - /home/travis/.m2/repository/AttendanceService/AttendanceService/0.0.1-SNAPSHOT/AttendanceService-0.0.1-SNAPSHOT.war
      - /home/travis/build/marcellp/attendance/platforms/android/build/outputs/apk/android-release.apk
    skip_cleanup: true
    on:
      repo: marcellp/attendance
      branch: master
      condition: '$TRAVIS_OS_NAME = linux'
  -
    provider: releases
    skip_cleanup: true
    api_key:
      secure: aaaJbBPWJBpJRhuPRCjGR1/nFNNJX325d74QxOcQvVLps5c7SjefRzAmk5yJZA1RVaaIL1ZK5hfr34UauHaxKp9tQ2oiZC6W5ORGvDlH6khd3Nj4zptRn0j/LKgjGOdZLpyR3FY2o/BgadfsTbrbeAVeDYmh639/j+l7uDRWeXseiQ/PnyHtBP9VaPsZdz4lO9t4vJjbBYxzAQiopqZwf3wRkUL6xRaJqFPCWVu8SKLfINpmtRH/Qco9Xe1IzewyNMBtAWSlEE8SbKGHb6vJmebepgRYbMMLpsws6fbfNxuBWmRlyPTxgwCFbsUC8lHmRbXz2qjY+aY1qlWnD2uWc8adMt0Ok81Qq+AQuGY/4JxX54UX+VYhyKrCbSjrzKQVMMoP3pDlhv3xzXbxYUbV1JQCZ+5mVhsmeAGY5/Dkb9vxODi33iXBJG+oz1sfWAm97gB/PvWitH/A0XbP3kUwgZ0Rypl5qBZx/ti6CK8NIGIrxA5sfpY/PdLxRsFfuq33yH/NWsGuEa36SLMOd8DcwjssT+Dw5AnTeCOjOuxiPTTLUuIlBY4juG7VmKw5HHLg7f6e3Xlm2SET3lTZIUyp3JHtXbG5a8cEWtXVwU7y+LGYxeMea75Bj4BjiYRf+xCecrnZ7z4L/+VCWVDTh+SfFGn7HCN53Cn+bkANAGgIu5mK/s=
    file: /Users/travis/build/marcellp/attendance/ios-build.zip
    on:
      repo: marcellp/attendance
      branch: master
      condition: '$TRAVIS_OS_NAME = osx'